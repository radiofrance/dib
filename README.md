DIB (Docker Image Builder) is a tool to build multiple Docker images hosted within the same repository. 

![CI Status](https://img.shields.io/github/workflow/status/radiofrance/dib/CI?label=CI&logo=github%20actions&logoColor=fff)
[![codecov](https://codecov.io/gh/radiofrance/dib/branch/main/graph/badge.svg)](https://codecov.io/gh/radiofrance/dib)
![GitHub release (latest SemVer)](https://img.shields.io/github/v/release/radiofrance/dib?sort=semver)

# Concepts

First, DIB creates a graph representation of all Dockerfiles in the repository with their dependencies. 
Imagine you have the following Dockerfiles in your repository (you can see this example in the `test/fixtures` directory).
Each image in a subfolder depends on the image in its parent directory (e.g. `sub-image` has a `FROM bullseye` instruction)

```
└── bullseye
    ├── Dockerfile
    ├── external-parent
    │   └── Dockerfile
    ├── multistage
    │   └── Dockerfile
    ├── skipbuild
    │   └── Dockerfile
    └── sub-image
        └── Dockerfile
```

Then, DIB will check the git diff between the current version of your repository and the previous one. 

To calculate this "previous" version, DIB use a file called `.docker-version` stored in the docker build directory.
The content of this file is a unique hash of the docker directoy, generated by `dib hash`. 

Then, for each dockerfile, if its was changed since the last update, it is taggued for rebuild. The tag of this newly
built image is the result of `dib hash`. If the image is unchanged, a new tag is created from the previous tag.

# Installation

First, install the cli

```
go install github.com/radiofrance/dib@latest
```

Dib uses a "referential" image to store metadata about previous runs. This image needs to be present on the remote 
registry. A bootstrap dockerfile is present in the `init` directory with the instructions to build it.

# Usage

Check `dib --help` for command usage

# License

dib is released under the [CeCILL V2.1 License](https://cecill.info/licences/Licence_CeCILL_V2.1-en.txt)
